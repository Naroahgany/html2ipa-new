name: Build Custom IPA

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'åº”ç”¨åç§°'
        required: true
      website_url:
        description: 'ç½‘é¡µé“¾æ¥'
        required: true
      icon_path:
        description: 'å›¾æ ‡æ–‡ä»¶è·¯å¾„'
        required: true
      request_id:
        description: 'è¯·æ±‚ID'
        required: true

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ğŸ¨ Prepare Icon
        run: |
          # ä»ä»“åº“ä¸­å¤åˆ¶å›¾æ ‡
          cp "${{ github.event.inputs.icon_path }}" icon.png
          echo "âœ… å›¾æ ‡å·²å‡†å¤‡å¥½: ${{ github.event.inputs.icon_path }}"
      
      - name: âœï¸ Customize App
        run: |
          # ä¿®æ”¹ç½‘é¡µ URL
          sed -i '' 's|let myTargetUrl = ".*"|let myTargetUrl = "${{ github.event.inputs.website_url }}"|' \
            iOSWKWebViewAppTemplateCookiesWorkLikeACharm/ViewController.swift
          
          # ä¿®æ”¹åº”ç”¨åç§°
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName ${{ github.event.inputs.app_name }}" \
            iOSWKWebViewAppTemplateCookiesWorkLikeACharm/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleName ${{ github.event.inputs.app_name }}" \
            iOSWKWebViewAppTemplateCookiesWorkLikeACharm/Info.plist
          
          echo "âœ… è‡ªå®šä¹‰å®Œæˆ: åº”ç”¨å=${{ github.event.inputs.app_name }}, URL=${{ github.event.inputs.website_url }}"

      - name: Build Xcode Project
        run: |
          PROJECT_FILE=$(find . -maxdepth 2 -name "*.xcodeproj" | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
          SCHEME_NAME="$PROJECT_NAME"
          
          # ç”Ÿæˆéšæœº Bundle IDï¼Œé˜²æ­¢ SideStore ç¼“å­˜å†²çª
          RANDOM_ID="com.html2ipa.app.$(date +%s)"
          
          xcodebuild clean -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME_NAME" -configuration Release
          
          xcodebuild build \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -derivedDataPath build \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$RANDOM_ID"

      - name: ğŸ“¦ Create IPA with Icons
        run: |
          # 1. å‡†å¤‡è·¯å¾„
          RAW_APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          APP_NAME="${{ github.event.inputs.app_name }}"
          REQUEST_ID="${{ github.event.inputs.request_id }}"
          
          mkdir Payload
          cp -R "$RAW_APP_PATH" "Payload/${APP_NAME}.app"
          
          TARGET_DIR="Payload/${APP_NAME}.app"
          SRC="icon.png"
          
          echo "ğŸ’ æ­£åœ¨æ¤å…¥è‡ªå®šä¹‰å›¾æ ‡..."
          
          # 2. ç›´æ¥å¤åˆ¶åŸå›¾åˆ°æ‰€æœ‰å¯èƒ½çš„ç³»ç»Ÿæ–‡ä»¶å
          cp "$SRC" "$TARGET_DIR/AppIcon60x60@2x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon60x60@3x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon76x76@2x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon83.5x83.5@2x.png"
          
          # é€šç”¨å…œåº•
          cp "$SRC" "$TARGET_DIR/AppIcon.png"
          cp "$SRC" "$TARGET_DIR/AppIcon@2x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon@3x.png"
          cp "$SRC" "$TARGET_DIR/Icon.png"
          cp "$SRC" "$TARGET_DIR/Icon@2x.png"
          
          # 3. éªŒè¯
          ls -lh "$TARGET_DIR" | grep "png"

          # 4. æ‰“åŒ… IPA
          IPA_NAME="${APP_NAME}_${REQUEST_ID}.ipa"
          zip -ry "$IPA_NAME" Payload
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV
          echo "âœ… IPA ç”Ÿæˆå®Œæˆ: $IPA_NAME"

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: "${{ github.event.inputs.app_name }}_${{ github.event.inputs.request_id }}"
          path: ./*.ipa
          retention-days: 7
